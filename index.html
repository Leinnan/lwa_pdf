<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Images to PDF Converter</title>
        <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            myorange: "#E66601",
                            "myorange-light": "#FF7A1A",
                            "myorange-dark": "#CC5500",
                            "myorange-darker": "#B34700",
                            mydark: "rgb(43, 43, 43)",
                            "mydark-light": "rgb(55, 55, 55)",
                            "mydark-lighter": "rgb(70, 70, 70)",
                            "mydark-lightest": "rgb(85, 85, 85)",
                            bodyDark: "#1D1F21",
                            "text-primary": "#F5F5F5",
                            "text-secondary": "#D1D1D1",
                            "text-muted": "#A0A0A0",
                            "text-subtle": "#808080",
                        },
                    },
                },
            };
        </script>
    </head>

    <body class="bg-bodyDark">
        <div
            class="flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 items-center"
        >
            <div
                class="w-full p-10 rounded-xl z-10 items-center justify-center bg-mydark"
            >
                <div
                    class="text-center sm:max-w-lg items-center justify-center ml-auto mr-auto"
                >
                    <h2 class="mt-5 text-3xl font-bold text-myorange">
                        Images to PDF converter
                    </h2>
                    <p class="mt-3 mb-2 text-sm text-text-secondary">
                        No ads. Nothing more, nothing less.
                    </p>
                    <div class="flex items-center justify-center w-full">
                        <div
                            id="loading-indicator"
                            style="display: none"
                            class="m-4 p-4 text-lg font-medium leading-none text-center text-myorange bg-mydark-light rounded-full animate-pulse border-2 border-myorange"
                        >
                            Loading...
                        </div>
                    </div>
                    <form id="file-catcher">
                        <!-- Drop Zone - shown when no files -->
                        <div
                            id="drop-zone"
                            class="flex items-center justify-center w-full"
                        >
                            <label
                                for="dropzone-file"
                                class="flex flex-col items-center justify-center w-full h-64 border-2 border-mydark-lighter border-dashed rounded-lg cursor-pointer bg-mydark-light hover:bg-mydark-lighter hover:border-myorange transition duration-300"
                            >
                                <div
                                    class="flex flex-col items-center justify-center pt-5 pb-6"
                                >
                                    <svg
                                        class="w-8 h-8 mb-4 text-text-muted"
                                        aria-hidden="true"
                                        xmlns="http://www.w3.org/2000/svg"
                                        fill="none"
                                        viewBox="0 0 20 16"
                                    >
                                        <path
                                            stroke="currentColor"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"
                                        />
                                    </svg>
                                    <p class="mb-2 text-sm text-text-secondary">
                                        <span
                                            class="font-semibold text-myorange"
                                            >Click to upload</span
                                        >
                                        or drag and drop
                                    </p>
                                    <p class="text-xs text-text-muted">
                                        image files
                                    </p>
                                </div>
                                <input
                                    id="dropzone-file"
                                    type="file"
                                    class="hidden"
                                    multiple
                                    accept="image/*"
                                />
                            </label>
                        </div>

                        <!-- Add More Files Button - shown when files exist -->
                        <div
                            id="add-more-section"
                            style="display: none"
                            class="flex items-center justify-center w-full mb-4"
                        >
                            <button
                                type="button"
                                id="add-more-btn"
                                class="flex items-center justify-center px-6 py-3 bg-mydark-lighter text-text-primary rounded-lg hover:bg-myorange hover:text-white transition duration-300 border border-mydark-lightest hover:border-myorange"
                            >
                                <svg
                                    class="w-5 h-5 mr-2"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                                    />
                                </svg>
                                Add More Files
                            </button>
                        </div>

                        <!-- File List Section -->
                        <div
                            id="file-list-container"
                            style="display: none"
                            class="mt-4 mb-4"
                        >
                            <h3
                                class="text-lg font-medium text-text-primary mb-3"
                            >
                                Added Files
                            </h3>
                            <ul
                                id="file-list"
                                class="space-y-3 max-h-96 overflow-y-auto"
                            >
                                <!-- File items will be populated here -->
                            </ul>
                            <button
                                type="button"
                                id="clear-files"
                                class="mt-3 px-4 py-2 bg-mydark-lighter text-text-primary rounded-lg hover:bg-myorange-dark hover:text-white transition duration-200 border border-mydark-lightest hover:border-myorange-dark"
                            >
                                Clear All Files
                            </button>
                        </div>

                        <button
                            type="submit"
                            id="submit-btn"
                            style="display: none"
                            class="my-5 w-full flex justify-center bg-myorange text-white p-4 rounded-full tracking-wide font-semibold focus:outline-none focus:ring-2 focus:ring-myorange-light hover:bg-myorange-light shadow-lg cursor-pointer transition ease-in duration-300"
                        >
                            Convert to PDF
                        </button>
                    </form>

                    <!-- Download Button -->
                    <div
                        id="download-section"
                        style="display: none"
                        class="mt-4"
                    >
                        <h3 class="text-xl font-semibold mb-2 text-myorange">
                            PDF generated!
                        </h3>
                        <button
                            type="button"
                            id="download-btn"
                            class="w-full flex justify-center items-center bg-myorange text-white p-4 rounded-full tracking-wide font-semibold focus:outline-none focus:ring-2 focus:ring-myorange-light hover:bg-myorange-light shadow-lg cursor-pointer transition ease-in duration-300"
                        >
                            <svg
                                class="w-5 h-5 mr-2"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                ></path>
                            </svg>
                            Download PDF
                        </button>
                    </div>
                </div>
                <section
                    id="pdf-viewer"
                    class="text-text-primary items-center justify-center"
                >
                    <details
                        class="mt-6 bg-mydark-light rounded-lg border border-mydark-lighter sm:block"
                    >
                        <summary
                            class="cursor-pointer p-4 text-lg font-medium text-text-primary hover:bg-mydark-lighter hover:text-myorange rounded-lg transition duration-200 select-none"
                        >
                            PDF Preview
                        </summary>
                        <div class="p-4 pt-0">
                            <iframe
                                id="viewer"
                                class="w-full h-screen rounded-lg border border-mydark-lightest bg-white"
                            ></iframe>
                        </div>
                    </details>
                    <button
                        type="button"
                        id="new-conversion-btn"
                        class="mt-3 flex justify-center bg-mydark-lighter text-text-primary px-4 py-2 rounded-lg tracking-wide font-medium focus:outline-none focus:ring-2 focus:ring-myorange hover:bg-myorange-dark hover:text-white transition ease-in duration-300 border border-mydark-lightest hover:border-myorange-dark"
                    >
                        Convert New Files
                    </button>
                </section>
            </div>
        </div>
        <script type="module">
            //import the library to talk to imagemagick
            import * as Magick from "https://knicknic.github.io/wasm-imagemagick/magickApi.js";
            const input = document.querySelector("#dropzone-file");
            const loading = document.querySelector("#loading-indicator");
            const fileForm = document.querySelector("#file-catcher");
            const previewSection = document.querySelector("#pdf-viewer");
            const iframe = document.getElementById("viewer");
            const dropZone = document.getElementById("drop-zone");
            const addMoreSection = document.getElementById("add-more-section");
            const addMoreBtn = document.getElementById("add-more-btn");
            const fileListContainer = document.getElementById(
                "file-list-container",
            );
            const fileList = document.getElementById("file-list");
            const clearFilesBtn = document.getElementById("clear-files");
            const submitBtn = document.getElementById("submit-btn");
            const downloadSection = document.getElementById("download-section");
            const downloadBtn = document.getElementById("download-btn");
            const newConversionBtn =
                document.getElementById("new-conversion-btn");

            loading.style.display = "none";
            previewSection.style.display = "none";
            iframe.style.display = "none";

            let selectedFiles = [];
            let currentPdfBlob = null;
            let currentPdfUrl = null;

            const readUploadedFileAsText = (inputFile) => {
                const temporaryFileReader = new FileReader();

                return new Promise((resolve, reject) => {
                    temporaryFileReader.onerror = () => {
                        temporaryFileReader.abort();
                        reject(new DOMException("Problem parsing input file."));
                    };

                    temporaryFileReader.onload = () => {
                        resolve(temporaryFileReader.result);
                    };
                    temporaryFileReader.readAsArrayBuffer(inputFile);
                });
            };

            const createImagePreview = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement("img");
                        img.src = e.target.result;
                        img.className =
                            "w-16 h-16 object-cover rounded-lg border border-mydark-lightest";
                        img.onerror = () => {
                            // If image fails to load, create a placeholder
                            const placeholder = document.createElement("div");
                            placeholder.className =
                                "w-16 h-16 bg-mydark-lighter rounded-lg border border-mydark-lightest flex items-center justify-center";
                            placeholder.innerHTML = `
                                <svg class="w-8 h-8 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            `;
                            resolve(placeholder);
                        };
                        img.onload = () => resolve(img);
                    };
                    reader.readAsDataURL(file);
                });
            };

            function cleanupPreviousPdf() {
                if (currentPdfUrl) {
                    URL.revokeObjectURL(currentPdfUrl);
                    currentPdfUrl = null;
                    currentPdfBlob = null;
                }
            }

            function moveFileUp(index) {
                if (index > 0) {
                    const file = selectedFiles[index];
                    selectedFiles.splice(index, 1);
                    selectedFiles.splice(index - 1, 0, file);
                    displayFileList();
                }
            }

            function moveFileDown(index) {
                if (index < selectedFiles.length - 1) {
                    const file = selectedFiles[index];
                    selectedFiles.splice(index, 1);
                    selectedFiles.splice(index + 1, 0, file);
                    displayFileList();
                }
            }

            async function displayFileList() {
                fileForm.style.display = "block";
                fileList.innerHTML = "";

                if (selectedFiles.length === 0) {
                    // Show drop zone, hide everything else
                    dropZone.style.display = "flex";
                    addMoreSection.style.display = "none";
                    fileListContainer.style.display = "none";
                    submitBtn.style.display = "none";
                    downloadSection.style.display = "none";
                    previewSection.style.display = "none";
                    iframe.style.display = "none";
                    cleanupPreviousPdf();
                    return;
                }

                // Hide drop zone, show add more button and file list
                dropZone.style.display = "none";
                addMoreSection.style.display = "flex";
                fileListContainer.style.display = "block";
                submitBtn.style.display = "block";

                for (let index = 0; index < selectedFiles.length; index++) {
                    const file = selectedFiles[index];
                    const li = document.createElement("li");
                    li.className =
                        "flex items-center justify-between p-4 bg-mydark-light rounded-lg cursor-move hover:bg-mydark-lighter transition duration-200 border border-mydark-lighter hover:border-myorange";
                    li.draggable = true;
                    li.dataset.index = index;

                    // Create up/down buttons container
                    const buttonsContainer = document.createElement("div");
                    buttonsContainer.className = "flex flex-row space-x-1 mr-3";

                    // Up button
                    if (index !== 0) {
                        const upButton = document.createElement("button");
                        upButton.type = "button";
                        upButton.className = `move-up p-2 rounded hover:bg-myorange transition duration-200 ${index === 0 ? "text-text-subtle cursor-not-allowed" : "text-text-muted hover:text-white"}`;
                        upButton.dataset.index = index;
                        upButton.disabled = index === 0;
                        upButton.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 15l7-7 7 7"></path>
                        </svg>
                    `;
                        buttonsContainer.appendChild(upButton);
                    }

                    // Down button
                    if (index !== selectedFiles.length - 1) {
                        const downButton = document.createElement("button");
                        downButton.type = "button";
                        downButton.className = `move-down p-2 rounded hover:bg-myorange transition duration-200 ${index === selectedFiles.length - 1 ? "text-text-subtle cursor-not-allowed" : "text-text-muted hover:text-white"}`;
                        downButton.dataset.index = index;
                        downButton.disabled =
                            index === selectedFiles.length - 1;
                        downButton.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    `;

                        buttonsContainer.appendChild(downButton);
                    }

                    // Create preview image
                    const preview = await createImagePreview(file);

                    // Create a container for the preview
                    const previewContainer = document.createElement("div");
                    previewContainer.className = "mr-4 flex-shrink-0";
                    previewContainer.appendChild(preview);

                    // Create file info container
                    const fileInfoContainer = document.createElement("div");
                    fileInfoContainer.className =
                        "flex items-center flex-grow min-w-0";
                    fileInfoContainer.innerHTML = `
                        <div class="flex flex-col min-w-0 flex-grow">
                            <span class="text-text-primary text-sm font-medium truncate">${file.name}</span>
                            <span class="text-text-secondary text-xs">${(file.size / 1024).toFixed(1)} KB</span>
                        </div>
                    `;

                    // Create drag handle and remove button container
                    const actionsContainer = document.createElement("div");
                    actionsContainer.className =
                        "flex items-center space-x-2 ml-4";
                    actionsContainer.innerHTML = `
                        <svg class="w-5 h-5 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                        </svg>
                        <button type="button" class="remove-file text-text-muted hover:text-myorange transition duration-200 p-1" data-index="${index}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    `;

                    // Assemble the list item
                    li.appendChild(buttonsContainer);
                    li.appendChild(previewContainer);
                    li.appendChild(fileInfoContainer);
                    li.appendChild(actionsContainer);

                    fileList.appendChild(li);
                }

                addDragAndDropListeners();
                addRemoveFileListeners();
                addMoveButtonListeners();
            }

            function addDragAndDropListeners() {
                const listItems = fileList.querySelectorAll("li");

                listItems.forEach((item) => {
                    item.addEventListener("dragstart", handleDragStart);
                    item.addEventListener("dragover", handleDragOver);
                    item.addEventListener("drop", handleDrop);
                    item.addEventListener("dragend", handleDragEnd);
                });
            }

            function addRemoveFileListeners() {
                const removeButtons = fileList.querySelectorAll(".remove-file");
                removeButtons.forEach((button) => {
                    button.addEventListener("click", (e) => {
                        e.stopPropagation();
                        const index = parseInt(button.dataset.index);
                        selectedFiles.splice(index, 1);
                        displayFileList();
                    });
                });
            }

            function addMoveButtonListeners() {
                // Up buttons
                const upButtons = fileList.querySelectorAll(".move-up");
                upButtons.forEach((button) => {
                    button.addEventListener("click", (e) => {
                        e.stopPropagation();
                        if (!button.disabled) {
                            const index = parseInt(button.dataset.index);
                            moveFileUp(index);
                        }
                    });
                });

                // Down buttons
                const downButtons = fileList.querySelectorAll(".move-down");
                downButtons.forEach((button) => {
                    button.addEventListener("click", (e) => {
                        e.stopPropagation();
                        if (!button.disabled) {
                            const index = parseInt(button.dataset.index);
                            moveFileDown(index);
                        }
                    });
                });
            }

            let draggedElement = null;

            function handleDragStart(e) {
                draggedElement = this;
                this.style.opacity = "0.5";
                this.style.borderColor = "#E66601";
            }

            function handleDragOver(e) {
                e.preventDefault();
            }

            function handleDrop(e) {
                e.preventDefault();

                if (this !== draggedElement) {
                    const draggedIndex = parseInt(draggedElement.dataset.index);
                    const targetIndex = parseInt(this.dataset.index);

                    // Reorder the files array
                    const draggedFile = selectedFiles[draggedIndex];
                    selectedFiles.splice(draggedIndex, 1);
                    selectedFiles.splice(targetIndex, 0, draggedFile);

                    displayFileList();
                }
            }

            function handleDragEnd(e) {
                this.style.opacity = "";
                this.style.borderColor = "";
                draggedElement = null;
            }

            // Handle file input change
            input.addEventListener("change", function (e) {
                // Add new files to existing selection instead of replacing
                const newFiles = Array.from(e.target.files);
                selectedFiles = [...selectedFiles, ...newFiles];
                displayFileList();
                // Clear the input so same files can be added again if needed
                e.target.value = "";
            });

            // Add More Files button
            addMoreBtn.addEventListener("click", function () {
                input.click();
            });

            // Clear all files
            clearFilesBtn.addEventListener("click", function () {
                selectedFiles = [];
                input.value = "";
                displayFileList();
            });

            // New conversion button
            newConversionBtn.addEventListener("click", function () {
                selectedFiles = [];
                input.value = "";
                downloadSection.style.display = "none";
                iframe.style.display = "none";
                cleanupPreviousPdf();
                displayFileList();
            });

            // Download button
            downloadBtn.addEventListener("click", function () {
                if (currentPdfBlob && currentPdfUrl) {
                    const link = document.createElement("a");
                    link.href = currentPdfUrl;
                    link.download = "converted-images.pdf";

                    // For mobile compatibility
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });

            async function generatePdf() {
                if (selectedFiles.length === 0) {
                    alert("Please select some files first!");
                    return;
                }

                // Clean up any previous PDF
                cleanupPreviousPdf();

                fileForm.style.display = "none";
                loading.style.display = "block";
                downloadSection.style.display = "none";
                iframe.style.display = "none";

                try {
                    let files = [];
                    console.log("Read started");

                    // Use the reordered selectedFiles array instead of input.files
                    for (let i = 0; i < selectedFiles.length; i++) {
                        let content = await readUploadedFileAsText(
                            selectedFiles[i],
                        );
                        let sourceBytes = new Uint8Array(content);
                        let file = {
                            name: selectedFiles[i].name,
                            content: sourceBytes,
                        };
                        files.push(file);
                    }
                    console.log("Read ended");

                    const command = ["convert", "*", "output.pdf"];
                    console.log("Call started");
                    let processedFiles = await Magick.Call(files, command);
                    console.log("Call ended");

                    // Store the blob and create URL for download
                    currentPdfBlob = processedFiles[0]["blob"];
                    currentPdfUrl = URL.createObjectURL(currentPdfBlob);
                    previewSection.style.display = "block";
                    // Display PDF in iframe
                    iframe.style.display = "block";
                    iframe.setAttribute("src", currentPdfUrl);

                    // Show download section
                    downloadSection.style.display = "block";
                } catch (error) {
                    console.error(error);
                    alert("Error generating PDF: " + error.message);
                }
                loading.style.display = "none";
                fileForm.style.display = "none";
            }

            var fileCatcher = document.getElementById("file-catcher");
            fileCatcher.addEventListener("submit", function (evnt) {
                evnt.preventDefault();
                generatePdf();
            });

            // Cleanup on page unload
            window.addEventListener("beforeunload", function () {
                cleanupPreviousPdf();
            });
        </script>

        <footer class="text-center">
            <span class="text-sm text-text-subtle"
                >© 2023
                <a
                    href="https://mevlyshkin.com/"
                    class="hover:underline hover:text-myorange transition duration-200"
                    >Mev Lyshkin™</a
                >. All Rights Reserved.
            </span>
        </footer>
    </body>
</html>
